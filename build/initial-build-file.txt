# Build Scripts for Automation

#!/bin/bash
set -e
set -v

# Install mysqldb
export DEBIAN_FRONTEND=noninteractive
sudo  debconf-set-selections <<< "mysql-server mysql-server/root_password password 2022-team01m"
sudo  debconf-set-selections <<< "mysql-server mysql-server/root_password_again password 2022-team01m"
sudo apt-get update
sudo apt-get install -y mysql-server

# Enable the service
sudo systemctl start mysql

# Inject the username and password for autologin later in a ~/.my.cnf file
# http://serverfault.com/questions/103412/how-to-change-my-mysql-root-password-back-to-empty/103423#103423
# https://stackoverflow.com/questions/8020297/mysql-my-cnf-file-found-option-without-preceding-group
#echo -e "[mysqld]" > /root/.my.cnf
#echo -e "\n\n[client]\nuser = root\npassword = $DBPASS" >> /root/.my.cnf
#echo -e "\nport = 3306\nsocket = /var/run/mysqld/mysqld.sock\n" >> /root/.my.cnf

# contents of create-database.sql
# CREATE DATABASE team01m DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
sudo mysql -u root -p < create-database.sql
# Change mysql bind address
sudo sed -i "s/.*bind-address.*/bind-address = 192.168.56.10/" /etc/mysql/mysql.conf.d/mysqld.cnf
# Create vagrant user
# contents of create-user.sql
# CREATE USER 'vagrant'@'localhost' IDENTIFIED BY '2022-team01m';
# GRANT ALL PRIVILEGES ON team01m.* TO 'vagrant'@'localhost' WITH GRANT OPTION;
# CREATE USER 'vagrant'@'%' IDENTIFIED BY '2022-team01m';
# GRANT ALL PRIVILEGES ON team01m.* TO 'vagrant'@'%' WITH GRANT OPTION;
# FLUSH PRIVILEGES;

# Front-end script
#Install PIP
#Install pre-reqs
sudo apt install -y python3-pip
python3 -m pip install --upgrade pip
sudo apt-get install -y python3-dev
sudo apt-get install -y default-libmysqlclient-dev
sudo apt-get install -y build-essential
python3 -m pip install mysqlclient

#Setup for DB connection
echo -e "[mysqld]" > /home/vagrant/.my.cnf.user
echo -e "[client]" >> /home/vagrant/.my.cnf
echo -e "host = 10.0.2.15" >> /home/vagrant/.my.cnf
echo -e "user = root" >> /home/vagrant/.my.cnf
echo -e "password = 2022-team01m" >> /home/vagrant/.my.cnf
#echo -e "database = team01m" >> /home/vagrant/.my.cnf

#Django installs
sudo apt install python3-django
python3 -m pip install Django
python3 -m pip install --upgrade Pillow #Library for images interface with DB
python3 -m pip install django-crispy-forms #Library for management of django forms

#Create Django project
mkdir /home/vagrant/website
cd /home/vagrant/website
django-admin startproject team01m

#Django settings.py depends on /home/vagrant/.my.cnf to be present

#Is this command required?
python3 manage.py migrate

#Start Django server
python3 manage.py runserver 192.168.56.10:8000


